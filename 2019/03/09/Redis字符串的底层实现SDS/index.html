<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/mmn-favicon-360x360.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/mmn-favicon-360x360.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/mmn-favicon-48x48.jpg?v=5.1.4"><link rel="mask-icon" href="/images/mmn-favicon.svg?v=5.1.4" color="#222"><meta name="keywords" content="Redis设计与实现,"><link rel="alternate" href="/atom.xml" title="猫玛尼" type="application/atom+xml"><meta name="description" content="【引子】Redis没有直接使用C语言传统的字符串表示，而是自己构建了一种名为简单动态字符串（Simple Dynamic String，SDS）的抽象类型，并将SDS用作Redis的默认字符串表示。"><meta name="keywords" content="Redis设计与实现"><meta property="og:type" content="article"><meta property="og:title" content="Redis字符串的底层实现SDS"><meta property="og:url" content="https://blog.moremoney.ink/2019/03/09/Redis字符串的底层实现SDS/index.html"><meta property="og:site_name" content="猫玛尼"><meta property="og:description" content="【引子】Redis没有直接使用C语言传统的字符串表示，而是自己构建了一种名为简单动态字符串（Simple Dynamic String，SDS）的抽象类型，并将SDS用作Redis的默认字符串表示。"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-03-09T14:04:34.357Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redis字符串的底层实现SDS"><meta name="twitter:description" content="【引子】Redis没有直接使用C语言传统的字符串表示，而是自己构建了一种名为简单动态字符串（Simple Dynamic String，SDS）的抽象类型，并将SDS用作Redis的默认字符串表示。"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://blog.moremoney.ink/2019/03/09/Redis字符串的底层实现SDS/"><title>Redis字符串的底层实现SDS | 猫玛尼</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/lyjloveabc" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">猫玛尼</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Stay Hungry, Stay Foolish.</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-todo"><a href="/ToDo/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br> ToDo</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.moremoney.ink/2019/03/09/Redis字符串的底层实现SDS/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="猫玛尼"><meta itemprop="description" content><meta itemprop="image" content="/images/mmn_avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猫玛尼"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Redis字符串的底层实现SDS</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-09T19:39:54+08:00">2019-03-09</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span></span> <span class="post-meta-divider">|</span><span class="page-pv"><i class="fa fa-file-o"></i><span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">2.3k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">8</span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="【引子】"><a href="#【引子】" class="headerlink" title="【引子】"></a>【引子】</h3><p>Redis没有直接使用C语言传统的字符串表示，而是自己构建了一种名为简单动态字符串（Simple Dynamic String，SDS）的抽象类型，并将SDS用作Redis的默认字符串表示。</p><a id="more"></a><p>在Redis里面，包含字符串值的键值对在底层都是由SDS实现的，比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set moremoney programmer</span><br></pre></td></tr></table></figure><p>那么Redis将在数据库中创建一个新的键值对，其中：</p><ul><li>该键值对的键moremoney是一个字符串对象，底层实现是一个保存了字符串“moremoney”的SDS</li><li>该键值对的值programmer也是一个字符串对象，底层实现是一个保存了字符串“programmer”的SDS</li></ul><p>除了以上用处，SDS还被用作AOF模块中的AOF缓冲区，以及客户端状态中的输入缓冲区等。</p><h3 id="【SDS的定义】"><a href="#【SDS的定义】" class="headerlink" title="【SDS的定义】"></a>【SDS的定义】</h3><p>SDS是通过C语言来实现的，我那会儿读大学时，学校最先开始教的是C语言，所以我对C语言也还算有点熟悉。</p><p>每个sds.h/sdshdr结构表示一个SDS值（为什么这么设计后续会分析）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">    <span class="comment">//记录buf数组中已使用字节的数量</span></span><br><span class="line">    <span class="comment">//等于SDS所保存字符串的长度</span></span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//记录buf数组中未使用的字节的数量</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">free</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//字节数组，用于保存字符串</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>简单来说：</p><ul><li>当free属性的值为0，则表示这个SDS没有分配任何未使用的空间；反之，则分配了free个字节的未使用的空间；</li><li>字符串的长度为len</li><li>buf属性是一个char类型的数组，数组的前面保存了该字符串的每个字符，最后一个字节则保存了一个空字符’\0’</li></ul><p>SDS遵循了C字符串以空字符结尾的惯例，保存空字符的1字节不会计算在len属性里面（也就是说保存“hello world”的字符串的SDS的len为11），并且为空字符分配的这个额外的1字节的空间，以及添加空字符到字符串末尾等操作，都是由SDS函数自动完成的，也就是说，这个空字符对于SDS的使用者或者Redis的使用者来说是完全透明的，这也体现了封装的思想，对外隐藏实现的细节，简化外部使用者。</p><p>SDS的设计者遵循空字符结尾的惯例的一个明显的好处，就是SDS可以直接重用一部分C字符串函数库里面的函数，比如打印字符串。</p><h3 id="【SDS与C字符串的区别】"><a href="#【SDS与C字符串的区别】" class="headerlink" title="【SDS与C字符串的区别】"></a>【SDS与C字符串的区别】</h3><p>根据传统，C语言使用长度为N+1的字符数组来表示长度为N的字符串，因为最后一个元素是空字符’\0’，表示C字符串的结尾。</p><p>C语言使用的这种实现方式，并不能满足Redis对字符串在安全性、效率，以及功能方面的要求。</p><h5 id="获取字符串长度"><a href="#获取字符串长度" class="headerlink" title="获取字符串长度"></a>获取字符串长度</h5><p>因为C字符串并没有记录字符串的长度信息，所以在获取C字符串长度的时候，必须遍历整个C字符串，遍历到的每个字符都要做计数+1，直到遇到代表字符串结尾的空字符’\0’为止（不计算进去），这个操作的时间复杂度就是O(N)，N为字符串长度。</p><p>SDS就不同了，由于SDS直接存储了字符串的长度len，想要获取一个用SDS表示的字符串的长度，只要读取len属性的值就行了，即时间复杂度仅为O(1)。</p><p>而且，无需使用者操心的是：设置和更新SDS的len属性的工作，都是由操作SDS的API在执行的时候自动完成的。</p><p>通过使用SDS，Redis将获取字符串长度所需的时间，从C字符串的O(N)降低到了O(1)，这确保了获取字符串长度的工作不会成为Redis的瓶颈。</p><h5 id="杜绝缓冲区溢出"><a href="#杜绝缓冲区溢出" class="headerlink" title="杜绝缓冲区溢出"></a>杜绝缓冲区溢出</h5><p>不记录C字符串的长度，容易造成缓冲区溢出（buffer overflow）。比如通过C函数strcat，将src字符串中的内容拼接到dest字符串的末尾：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">strcat</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>;</span><br></pre></td></tr></table></figure><p>由于C字符串不记录自身的长度，如果用户在执行strcat函数时，没有给dest分配足够的内容来容纳src，就会产生缓冲区溢出。</p><p>SDS的空间分配策略，能够完全杜绝缓冲区溢出的发生：当SDS API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改的需求，若不满足，则API会自动将SDS的空间扩展以至于能够放下src。</p><h5 id="修改SDS字符串N次，真的会像C字符串那样，一定做N次内存重分配吗？"><a href="#修改SDS字符串N次，真的会像C字符串那样，一定做N次内存重分配吗？" class="headerlink" title="修改SDS字符串N次，真的会像C字符串那样，一定做N次内存重分配吗？"></a>修改SDS字符串N次，真的会像C字符串那样，一定做N次内存重分配吗？</h5><p>我们从前面的文章了解到“C字符串不记录自身的长度”，通过最后一个空字符’\0’来表示字符串结束。所以每次拉长或缩短C字符串，程序总要对保存这个C字符串的数组进行一次内存重分配：</p><ul><li>拉长：程序需要先通过内存重分配来扩展底层数组的空间，如果忘了这一步就会产生缓冲区溢出</li><li>缩短：程序需要先通过内存重分配来释放字符串不再使用的那部分空间，如果忘了这一步就会产生内存泄漏</li></ul><p>由于涉及复杂的算法，且可能需要执行系统调用，所以相对来说，内存重分配是一个比较耗时的操作。Redis作为一个对性能有极致要求的数据库，如果这种操作频繁的发生，可能就会造成一些瓶颈了。</p><p>为了避免C字符串的这种缺陷，SDS的设计者相处了一个巧妙的办法：通过未使用空间来解除字符串长度和底层数组长度之间的关联。在SDS中，buf数组的长度不一定就是字符数量+1（+1是最后还是存了空字符’\0’），宿主里面可以包含未使用的字节，这些未使用的字节数量就是free的值。</p><p>通过未使用空间，SDS实现了空间预分配和惰性空间释放两种优化策略。</p><ul><li><p>空间预分配：当API对一个SDS进行修改，并且需要对SDS空间进行扩展，程序不仅会为SDS分配修改所必须的空间，还会额外分配“未使用空间”，额外分配策略有2种：</p><ol><li>如果对SDS进行修改之后，len小于1MB，那么程序分配和len一样大小的未使用空间</li><li>如果对SDS进行修改之后，len大于1MB，那么程序分配1MB的未使用空间</li></ol><p>空间预分配的好处是，减少连续执行字符串增长操作所需的内存重分配次数：在扩展SDS空间之前，SDS API会先检查未使用空间是否足够，如果足够的话，API就会直接使用未使用空间，而不会执行内存重分配。</p></li><li><p>惰性空间释放：当需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性来将这些字节记录起来，可供将来扩展使用，相当于优化了将来可能有的增长操作，因为空出来了字节，那么能够容纳增长的字符的话就不需要再内存重分配了。</p></li></ul><p>可能你会担心，惰性空间释放这个特性，会造成内存泄漏，其实SDS提供了相关API，让我们在有需要的时候，真正的释放SDS的未使用空间。</p><h5 id="二进制安全"><a href="#二进制安全" class="headerlink" title="二进制安全"></a>二进制安全</h5><p>之前有篇文章有提到“二进制安全是什么？”，这里不再详述，简单来说就是C字符串存在二进制安全的问题，它职能保存文本数据，而不能保存像图片、音频、视频压缩文件等二进制数据，因为遇到’\0’就是一个结束了的C字符串。</p><p>而SDS的API都是二进制安全的，所有API以处理二进制的方式来处理SDS存放的buf数组里的数据，程序不会对其中的数据做任何限制、过滤、或者转义，数据在写入时是怎么样的，被读取时就是什么样。这也是将SDS的buf数组叫做字节数组的原因——Redis不是用这个数组来保存字符，而使用它来直接保存二进制数据。</p><p>所以，Redis不仅可以保存文本，还可以保存任意的二进制数据。非常强大。</p><h5 id="兼容部分C字符串函数"><a href="#兼容部分C字符串函数" class="headerlink" title="兼容部分C字符串函数"></a>兼容部分C字符串函数</h5><p>前面提到过，SDS遵循了C字符串以空字符’\0’结尾的惯例，并且SDS的API自动维护了这个空字符，所以SDS可以重用一部分&lt;string.h&gt;库定义的函数。这样Redis就不用重复去造轮子了。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">------------- 本文结束<i class="fa fa-paw"></i>感谢阅读 -------------</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>给猫玛尼加个鸡腿~</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/mmn-wechatpay.jpeg" alt="猫玛尼 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/mmn-alipay.jpeg" alt="猫玛尼 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 猫玛尼</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://blog.moremoney.ink/2019/03/09/Redis字符串的底层实现SDS/" title="Redis字符串的底层实现SDS">https://blog.moremoney.ink/2019/03/09/Redis字符串的底层实现SDS/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Redis设计与实现/" rel="tag"><i class="fa fa-tag"></i> Redis设计与实现</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/03/06/解决：MacOS出现crun-error-invalid-active-developer-path-……的问题/" rel="next" title="解决：MacOS出现crun: error: invalid active developer path ……的问题"><i class="fa fa-chevron-left"></i> 解决：MacOS出现crun: error: invalid active developer path ……的问题</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80MjkyNy8xOTQ3Mw=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/mmn_avatar.jpg" alt="猫玛尼"><p class="site-author-name" itemprop="name">猫玛尼</p><p class="site-description motion-element" itemprop="description">主要涉及技术、职业、生活、财务、随笔。崇尚科技可以改变世界、造福人类，是终生学习的实践者。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">18</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/lyjloveabc" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luoyanjiewade@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/luoyanjiewade" target="_blank" title="Csdn"><i class="fa fa-fw fa-globe"></i> Csdn</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/luo-yan-jie-70/activities" target="_blank" title="Zhihu"><i class="fa fa-fw fa-globe"></i> Zhihu</a></span><span class="links-of-author-item"><a href="/about" target="_blank" title="Wechat"><i class="fa fa-fw fa-globe"></i> Wechat</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://www.jianshu.com/u/eb14d183c0f5" title="GF" target="_blank">GF</a></li><li class="links-of-blogroll-item"> <a href="https://www.joelonsoftware.com/" title="JOEL ON SOFTWARE" target="_blank">JOEL ON SOFTWARE</a></li><li class="links-of-blogroll-item"> <a href="https://github.com/ruanyf" title="Ruan YiFeng" target="_blank">Ruan YiFeng</a></li><li class="links-of-blogroll-item"> <a href="http://hellojava.info" title="毕玄" target="_blank">毕玄</a></li><li class="links-of-blogroll-item"> <a href="https://coolshell.cn/haoel" title="左耳朵耗子" target="_blank">左耳朵耗子</a></li><li class="links-of-blogroll-item"> <a href="http://lovestblog.cn/" title="你假笨" target="_blank">你假笨</a></li><li class="links-of-blogroll-item"> <a href="http://www.dongwm.com/" title="董伟明" target="_blank">董伟明</a></li><li class="links-of-blogroll-item"> <a href="https://tech.meituan.com/" title="美团点评团队" target="_blank">美团点评团队</a></li><li class="links-of-blogroll-item"> <a href="https://javadoop.com/" title="java熊" target="_blank">java熊</a></li><li class="links-of-blogroll-item"> <a href="http://www.ityouknow.com/" title="纯洁的微笑" target="_blank">纯洁的微笑</a></li><li class="links-of-blogroll-item"> <a href="http://www.ityouknow.com/" title="姜逸坤" target="_blank">姜逸坤</a></li><li class="links-of-blogroll-item"> <a href="http://oilbeater.com/" title="Oilbeater" target="_blank">Oilbeater</a></li><li class="links-of-blogroll-item"> <a href="http://brianway.github.io/" title="魏楚阳" target="_blank">魏楚阳</a></li><li class="links-of-blogroll-item"> <a href="https://livc.io/" title="李钊" target="_blank">李钊</a></li><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="翟永超" target="_blank">翟永超</a></li><li class="links-of-blogroll-item"> <a href="https://muyinchen.github.io/" title="一叶知秋" target="_blank">一叶知秋</a></li><li class="links-of-blogroll-item"> <a href="https://gcat.ml/" title="橘喵" target="_blank">橘喵</a></li><li class="links-of-blogroll-item"> <a href="http://www.ftchinese.com/" title="FT" target="_blank">FT</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#【引子】"><span class="nav-number">1.</span> <span class="nav-text">【引子】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#【SDS的定义】"><span class="nav-number">2.</span> <span class="nav-text">【SDS的定义】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#【SDS与C字符串的区别】"><span class="nav-number">3.</span> <span class="nav-text">【SDS与C字符串的区别】</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#获取字符串长度"><span class="nav-number">3.0.1.</span> <span class="nav-text">获取字符串长度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#杜绝缓冲区溢出"><span class="nav-number">3.0.2.</span> <span class="nav-text">杜绝缓冲区溢出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改SDS字符串N次，真的会像C字符串那样，一定做N次内存重分配吗？"><span class="nav-number">3.0.3.</span> <span class="nav-text">修改SDS字符串N次，真的会像C字符串那样，一定做N次内存重分配吗？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#二进制安全"><span class="nav-number">3.0.4.</span> <span class="nav-text">二进制安全</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#兼容部分C字符串函数"><span class="nav-number">3.0.5.</span> <span class="nav-text">兼容部分C字符串函数</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">猫玛尼</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">全站共计字数&#58;</span> <span title="全站共计字数">18.4k</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html>