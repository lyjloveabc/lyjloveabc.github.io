<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/mmn-favicon-360x360.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/mmn-favicon-360x360.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/mmn-favicon-48x48.jpg?v=5.1.4"><link rel="mask-icon" href="/images/mmn-favicon.svg?v=5.1.4" color="#222"><meta name="keywords" content="基础,"><link rel="alternate" href="/atom.xml" title="猫玛尼" type="application/atom+xml"><meta name="description" content="charAt() 方法用于返回指定索引处的字符。索引范围为从 0 到 length() - 1。 public char charAt(int index) index – 字符的索引。  事情发生在昨天，今天整理出来。 线上客服爆出“C端APP上的某个促销活动的活动详情无法打开”，通过客户端同学小T查看，该BUG的现象是：同一个活动详情，Android没有报错能展示活动详情（后来发现有一个乱码"><meta name="keywords" content="基础"><meta property="og:type" content="article"><meta property="og:title" content="charAt引发的血案"><meta property="og:url" content="https://blog.moremoney.ink/2019/03/26/charAt引发的血案/index.html"><meta property="og:site_name" content="猫玛尼"><meta property="og:description" content="charAt() 方法用于返回指定索引处的字符。索引范围为从 0 到 length() - 1。 public char charAt(int index) index – 字符的索引。  事情发生在昨天，今天整理出来。 线上客服爆出“C端APP上的某个促销活动的活动详情无法打开”，通过客户端同学小T查看，该BUG的现象是：同一个活动详情，Android没有报错能展示活动详情（后来发现有一个乱码"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-03-26T08:57:23.858Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="charAt引发的血案"><meta name="twitter:description" content="charAt() 方法用于返回指定索引处的字符。索引范围为从 0 到 length() - 1。 public char charAt(int index) index – 字符的索引。  事情发生在昨天，今天整理出来。 线上客服爆出“C端APP上的某个促销活动的活动详情无法打开”，通过客户端同学小T查看，该BUG的现象是：同一个活动详情，Android没有报错能展示活动详情（后来发现有一个乱码"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://blog.moremoney.ink/2019/03/26/charAt引发的血案/"><title>charAt引发的血案 | 猫玛尼</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/lyjloveabc" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">猫玛尼</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Stay Hungry, Stay Foolish.</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-todo"><a href="/ToDo/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br> ToDo</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://blog.moremoney.ink/2019/03/26/charAt引发的血案/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="猫玛尼"><meta itemprop="description" content><meta itemprop="image" content="/images/mmn_avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="猫玛尼"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">charAt引发的血案</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-26T14:25:52+08:00">2019-03-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span></span> <span class="post-meta-divider">|</span><span class="page-pv"><i class="fa fa-file-o"></i><span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">1.8k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">7</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>charAt() 方法用于返回指定索引处的字符。索引范围为从 0 到 length() - 1。</p><p>public char charAt(int index)</p><p>index – 字符的索引。</p></blockquote><p>事情发生在昨天，今天整理出来。</p><p>线上客服爆出“C端APP上的某个促销活动的活动详情无法打开”，通过客户端同学小T查看，该BUG的现象是：同一个活动详情，Android没有报错能展示活动详情（后来发现有一个乱码），而IOS直接报错无法展示任何信息。两端的其他活动详情都正常。</p><a id="more"></a><p>出现这种只有其中一类客户端有异常的情况，我一般判断是这类客户端自身的问题，而不是接口的问题，所以开始我没有详细跟进。</p><p>一段时间后，搞IOS的小T挠头抓耳的发给我一堆报错信息：</p><p>“Unable to convert hex escape sequence (no high character) to UTF8-encoded character.” UserInfo={NSDebugDescription=Unable to convert hex escape sequence (no high character) to UTF8-encoded character.</p><p>然后跟我说，这不是他们IOS的问题，是接口返回的某个字符串有问题，他们没法解析。</p><p>接口没有给IOS做特殊返回啊，怎么会发送了没法解析的字符串给IOS呢？况且Android也没有报错呢。</p><p><strong>辩论是谁的过错没有意义，解决问题才是王道。</strong></p><p>仔细去看小T发给我的报错，初步判断是字符编码的问题。我用浏览器访问接口，观察返回的结果，一小段乱码吸引了我的注意力。看业务，知道这段乱码是已下单用户的昵称。结合小T发给我的异常信息，我感觉问题就是出在乱码这里。</p><p>我找到数据库里面这个用户的昵称，发现他的昵称最后带了一个表情“😊”，有点与众不同。</p><p>再看接口的具体代码，发现代码有对用户的昵称做特殊处理，目的是隐藏用户的昵称信息，具体代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取业主昵称的模糊化数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getPreName</span><span class="params">(UsersDO usersDO)</span> </span>&#123;</span><br><span class="line">  String preName = DEFAULT_NAME;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (usersDO != <span class="keyword">null</span> &amp;&amp; StringUtils.isNotBlank(usersDO.getNick())) &#123;</span><br><span class="line">    <span class="keyword">char</span> first = usersDO.getNick().charAt(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (usersDO.getNick().length() == <span class="number">1</span>) &#123;</span><br><span class="line">      preName = first + <span class="string">"**"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      preName = first + <span class="string">"**"</span> + usersDO.getNick().charAt(usersDO.getNick().length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> preName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码对昵称做了切割处理，取了第一个字符和最后一个字符，中间变成**，我意识到，应该是这个切割把表情“😊”切出问题变成了乱码，这个表情很可能并不是一个单纯的Java的char。遂，我写了一段代码，去验证我的想法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//这个testStr实际上就是"特殊的昵称😊"，我把表情复制上去，就自动变成了橘黄色的Unicode数值</span></span><br><span class="line">        String testStr = <span class="string">"特殊的昵称\uD83D\uDE0A"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"字符串的长度："</span> + testStr.length());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"所有字符串如下："</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : testStr.toCharArray()) &#123;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印的结果如下：</span></span><br><span class="line">字符串的长度：<span class="number">7</span></span><br><span class="line">所有字符串如下：</span><br><span class="line">特</span><br><span class="line">殊</span><br><span class="line">的</span><br><span class="line">昵</span><br><span class="line">称</span><br><span class="line">?</span><br><span class="line">?</span><br></pre></td></tr></table></figure><p>种种迹象表明这个表情“😊”并不是一个单纯的Java char，而是两个Java char，所以usersDO.getNick().charAt(usersDO.getNick().length() - 1)之后，会得出乱码。</p><p>这是我的知识盲区啊，以前从来没有担心过这种Java基础API也有“坑”(是我用的不对，并不是真的Java坑)。</p><p>看了charAt的源码，理解的不是那么透彻。我祭出：</p><p><strong>哪里不懂，Google哪里！</strong></p><p>看到一篇来自Umer Mansoor的文章《The char Type in Java is Broken》（原文<a href="https://codeahoy.com/2016/05/08/the-char-type-in-java-is-broken/" target="_blank" rel="noopener">https://codeahoy.com/2016/05/08/the-char-type-in-java-is-broken/</a> ），标题就很炸人。说的是Java的char存储位数的问题。看到其中一段话：</p><blockquote><p><code>char</code> uses 16 bits to store Unicode characters that fall in the 0 - 65,535 which isn’t enough to store all Unicode characters anymore. You might think: <em>Gee, 65,535 is plenty already. I’ll never use that many</em>. That’s true. But your users will. And when they send you a character that requires more than 16 bits, like these emojis 👦👩, <strong>the char methods like someString.charAt(0) or someString.substring(0,1) will break and give you only half the code point. And the worst part is that the compiler won’t even complain</strong>. Recently, a fellow developer told me that their “North American users” started complaining that the chat nicknames and messages “aren’t displaying properly”. After a lot of grief, they found the issue and had to undo all <code>char</code> manipulation in their software to handle emojis and other cool characters. (Use <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/String.html#codePointAt(int" target="_blank" rel="noopener"><code>codePointAt(index)</code></a>)instead which returns an int that will fit all Unicode characters in existence.)</p></blockquote><p>加粗的那句话，大概意思是：类似charAt、substring会破坏emoji表情，只返回半个编码。</p><p>多方求证，得出个大概：</p><p>早期Java版本使用16位char数据类型表示Unicode字符，且能够表示当时所有的Unicode字符。随着时代发展，Unicode后来将最大值增加到1,114,111(0x10FFFF)，16位根本存不下了。但与32位值相比，16位值的内存使用效率更高，因此Unicode引入了一种代理对的设计方法来允许继续使用16位值。它使用一个高代理加上一个低代理来表示16位无法表示下的字符。</p><p>Java保留了char类型的行为来表示UTF-16值（以便兼容现有程序），它实现了码位的概念来表示 UTF-32 值。这个扩展（根据 JSR 204：Unicode Supplementary Character Support 实现）不需要记住Unicode码位或转换算法的准确值。</p><p>如果通过Java API来正确处理char呢？</p><p>Java提供了如下API来操作码位（一个码位可以理解成一个肉眼可见的字符，emoji表情也是一个字符，而不是被charAt成两段）：</p><blockquote><p>public int codePointCount(int beginIndex, int endIndex);//返回范围内代码点的个数，即多少个Unicode字符</p><p>public int offsetByCodePoints(int index, int codePointOffset);//返回从index偏移codePointOffset代码点后的索引</p><p>public int codePointAt(int index);//返回字符串指定位置的Unicode代码点的Unicode值</p><p>public int codePointBefore(int index);//返回字符串所在索引－1的Unicode代码点</p></blockquote><p>那我们的这个业务需求，其实可以简化为：</p><p>在昵称不为空的前提下，计算昵称的代码点总个数：如果代码点只有1个，那取第一个代码点的字符，再在后面补星星；如果代码点超过1个，那取第一个代码点字符，再在后面补星星，最后补上最后一个代码点的字符</p><p>结合subString方法，最终代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">该版本，考虑Emoji等超过2字节的字符</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getPreNameV2</span><span class="params">(UsersDO usersDO)</span> </span>&#123;</span><br><span class="line">  String preName = DEFAULT_NAME;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (usersDO != <span class="keyword">null</span> &amp;&amp; StringUtils.isNotBlank(usersDO.getNick())) &#123;</span><br><span class="line">    String nick = usersDO.getNick();</span><br><span class="line">    String firstUnicodeStr = nick.substring(<span class="number">0</span>, nick.offsetByCodePoints(<span class="number">0</span>, <span class="number">1</span>));<span class="comment">//第一个字符</span></span><br><span class="line">    <span class="keyword">int</span> codePointCount = nick.codePointCount(<span class="number">0</span>, nick.length());<span class="comment">//一共有多少个代码点</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (codePointCount == <span class="number">1</span>) &#123;</span><br><span class="line">      preName = firstUnicodeStr + <span class="string">"**"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      preName = firstUnicodeStr + <span class="string">"**"</span> + nick.substring(nick.offsetByCodePoints(<span class="number">0</span>, codePointCount - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> preName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码改完，已经测试通过上线了。</p><p>(Android没有报错，只是显示乱码，我觉得是因为Android同样也是Java体系的原因)</p><p>基础不牢地动山摇啊！keep moving</p><p>引用的文章</p><blockquote><p><a href="https://codeahoy.com/2016/05/08/the-char-type-in-java-is-broken/" target="_blank" rel="noopener">https://codeahoy.com/2016/05/08/the-char-type-in-java-is-broken/</a></p><p><a href="https://www.ibm.com/developerworks/cn/java/j-unicode/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-unicode/index.html</a></p><p><a href="https://codeday.me/bug/20180314/143840.html" target="_blank" rel="noopener">https://codeday.me/bug/20180314/143840.html</a></p><p><a href="http://pclevin.blogspot.com/2011/12/javastring_27.html" target="_blank" rel="noopener">http://pclevin.blogspot.com/2011/12/javastring_27.html</a></p><p><a href="http://lugeek.com/2014/10/27/java-string/" target="_blank" rel="noopener">http://lugeek.com/2014/10/27/java-string/</a></p><p><a href="https://www.javatpoint.com/post/java-character-codepointat-method" target="_blank" rel="noopener">https://www.javatpoint.com/post/java-character-codepointat-method</a></p></blockquote></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">------------- 本文结束<i class="fa fa-paw"></i>感谢阅读 -------------</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>给猫玛尼加个鸡腿~</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/mmn-wechatpay.jpeg" alt="猫玛尼 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/mmn-alipay.jpeg" alt="猫玛尼 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 猫玛尼</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://blog.moremoney.ink/2019/03/26/charAt引发的血案/" title="charAt引发的血案">https://blog.moremoney.ink/2019/03/26/charAt引发的血案/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/基础/" rel="tag"><i class="fa fa-tag"></i> 基础</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/03/13/幂次法则/" rel="next" title="幂次法则"><i class="fa fa-chevron-left"></i> 幂次法则</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80MjkyNy8xOTQ3Mw=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/mmn_avatar.jpg" alt="猫玛尼"><p class="site-author-name" itemprop="name">猫玛尼</p><p class="site-description motion-element" itemprop="description">主要涉及技术、职业、生活、财务、随笔。崇尚科技可以改变世界、造福人类，是终生学习的实践者。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">18</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/lyjloveabc" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luoyanjiewade@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/luoyanjiewade" target="_blank" title="Csdn"><i class="fa fa-fw fa-globe"></i> Csdn</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/luo-yan-jie-70/activities" target="_blank" title="Zhihu"><i class="fa fa-fw fa-globe"></i> Zhihu</a></span><span class="links-of-author-item"><a href="/about" target="_blank" title="Wechat"><i class="fa fa-fw fa-globe"></i> Wechat</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://blog.csdn.net/weixin_41452576" title="GF" target="_blank">GF</a></li><li class="links-of-blogroll-item"> <a href="https://www.joelonsoftware.com/" title="JOEL ON SOFTWARE" target="_blank">JOEL ON SOFTWARE</a></li><li class="links-of-blogroll-item"> <a href="https://github.com/ruanyf" title="Ruan YiFeng" target="_blank">Ruan YiFeng</a></li><li class="links-of-blogroll-item"> <a href="http://hellojava.info" title="毕玄" target="_blank">毕玄</a></li><li class="links-of-blogroll-item"> <a href="https://coolshell.cn/haoel" title="左耳朵耗子" target="_blank">左耳朵耗子</a></li><li class="links-of-blogroll-item"> <a href="http://lovestblog.cn/" title="你假笨" target="_blank">你假笨</a></li><li class="links-of-blogroll-item"> <a href="https://codeahoy.com/" title="Umer Mansoor" target="_blank">Umer Mansoor</a></li><li class="links-of-blogroll-item"> <a href="http://www.dongwm.com/" title="董伟明" target="_blank">董伟明</a></li><li class="links-of-blogroll-item"> <a href="https://tech.meituan.com/" title="美团点评团队" target="_blank">美团点评团队</a></li><li class="links-of-blogroll-item"> <a href="https://javadoop.com/" title="java熊" target="_blank">java熊</a></li><li class="links-of-blogroll-item"> <a href="http://www.ityouknow.com/" title="纯洁的微笑" target="_blank">纯洁的微笑</a></li><li class="links-of-blogroll-item"> <a href="http://www.ityouknow.com/" title="姜逸坤" target="_blank">姜逸坤</a></li><li class="links-of-blogroll-item"> <a href="http://oilbeater.com/" title="Oilbeater" target="_blank">Oilbeater</a></li><li class="links-of-blogroll-item"> <a href="http://brianway.github.io/" title="魏楚阳" target="_blank">魏楚阳</a></li><li class="links-of-blogroll-item"> <a href="https://livc.io/" title="李钊" target="_blank">李钊</a></li><li class="links-of-blogroll-item"> <a href="http://blog.didispace.com/" title="翟永超" target="_blank">翟永超</a></li><li class="links-of-blogroll-item"> <a href="https://muyinchen.github.io/" title="一叶知秋" target="_blank">一叶知秋</a></li><li class="links-of-blogroll-item"> <a href="https://gcat.ml/" title="橘喵" target="_blank">橘喵</a></li><li class="links-of-blogroll-item"> <a href="http://www.ftchinese.com/" title="FT" target="_blank">FT</a></li></ul></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">猫玛尼</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">全站共计字数&#58;</span> <span title="全站共计字数">20.8k</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html>